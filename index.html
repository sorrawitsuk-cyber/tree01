<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bangkok Green Monitor - ระบบติดตามพื้นที่สีเขียว</title>
    
    <!-- 1. Load Utilities -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <!-- 2. React Core -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 3. Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 4. UI Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/recharts@2.12.0/umd/Recharts.js"></script>
    
    <!-- 5. Map Library -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- 6. Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f0fdf4; /* Green-50 */
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scroll, handle in app */
        }
        
        #root {
            height: 100vh;
            width: 100vw;
        }

        /* Loading Spinner */
        #initial-loader {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
            background-color: #f0fdf4;
            color: #166534;
            font-size: 1.5rem;
            font-weight: bold;
            flex-direction: column;
            gap: 1rem;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #bbf7d0;
            border-top: 4px solid #16a34a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body>
    <!-- Initial Loading State (Removed by React when loaded) -->
    <div id="root">
        <div id="initial-loader">
            <div class="spinner"></div>
            <div>กำลังโหลดข้อมูล...</div>
        </div>
    </div>

    <script type="text/babel">
        // Safe Access to Globals
        const { useState, useEffect, useMemo, useRef } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell } = window.Recharts || {};
        const L = window.L;

        // --- Configuration ---
        const PUBLIC_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQXj3ANlfrhd00qkUJlPPSqR6GrIZethvWJem7gyLBGyihVjIqE4Lx2hTufmLuNgmK8NR89vQly0WeU/pub?gid=0&single=true&output=csv";

        // --- Mock Data ---
        const INITIAL_DATA = [
            { id: 12101, district: 'ประเวศ', subdistrict: 'หนองบอน', lat: 13.68753, lng: 100.656281, date: '30/07/2565', name: 'ต้นคูน', type: 'ไม้ยืนต้น', quantity: 1, image: '' },
            { id: 1983101, district: 'พระนคร', subdistrict: 'สำราญราษฎร์', lat: 13.750815, lng: 100.504784, date: '03/02/2026', name: 'ไทรเกาหลี', type: 'ไม้พุ่ม', quantity: 840, image: 'https://tree.bangkok.go.th/media/tree_items/EPB2xRRzFUZne5DULUSo6o.jpg' },
            { id: 1729806, district: 'บางกอกใหญ่', subdistrict: 'วัดท่าพระ', lat: 13.730381, lng: 100.470842, date: '01/02/1980', name: 'ตะขบบ้าน', type: 'ไม้ยืนต้น', quantity: 1, image: 'https://tree.bangkok.go.th/media/tree_items/BUAMZBKQWXZBLCGGNJVOKZAOCPLE.jpg' },
            { id: 1729807, district: 'บางกอกใหญ่', subdistrict: 'วัดท่าพระ', lat: 13.730381, lng: 100.470842, date: '01/02/1980', name: 'หูกวาง', type: 'ไม้ยืนต้น', quantity: 1, image: 'https://tree.bangkok.go.th/media/tree_items/ALIMGJEENAGIUUWZQMDFENQHGSUU.jpg' },
            { id: 11111, district: 'จตุจักร', subdistrict: 'ลาดยาว', lat: 13.8282, lng: 100.5591, date: '15/01/2026', name: 'ราชพฤกษ์', type: 'ไม้ยืนต้น', quantity: 20, image: '' },
            { id: 22222, district: 'ปทุมวัน', subdistrict: 'ลุมพินี', lat: 13.7300, lng: 100.5400, date: '20/01/2026', name: 'จามจุรี', type: 'ไม้ยืนต้น', quantity: 5, image: '' },
            { id: 33333, district: 'บางรัก', subdistrict: 'สีลม', lat: 13.7200, lng: 100.5200, date: '25/01/2026', name: 'ทองกวาว', type: 'ไม้ยืนต้น', quantity: 12, image: '' },
            { id: 44444, district: 'พญาไท', subdistrict: 'สามเสนใน', lat: 13.7800, lng: 100.5400, date: '28/01/2026', name: 'ประดู่', type: 'ไม้ยืนต้น', quantity: 8, image: '' },
        ];

        const COLORS = ['#16a34a', '#84cc16', '#22c55e', '#15803d', '#4ade80', '#14532d', '#3f6212', '#65a30d'];

        // --- Icons (SVG Components) ---
        const IconTree = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 10v.2A3 3 0 0 1 8.9 16v0H5v0h0a3 3 0 0 1-1-5.8V10a3 3 0 0 1 5.3-2.1"/><path d="M7 16v6"/><path d="M13 19v3"/><path d="M12 19h8.3a1 1 0 0 0 .7-1.7L18 14h.3a1 1 0 0 0 .7-1.7L16 9h.2a1 1 0 0 0 .9-1.7l-2-6a1 1 0 0 0-1.9 0l-2 6a1 1 0 0 0 .9 1.7h.2l-2 3.3a1 1 0 0 0 .7 1.7H13z"/></svg>;
        const IconMap = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" x2="9" y1="3" y2="18"/><line x1="15" x2="15" y1="6" y2="21"/></svg>;
        const IconBarChart = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></svg>;
        const IconUpload = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>;
        const IconCloudDownload = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m8 17 4 4 4-4"/></svg>;
        const IconGallery = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>;
        const IconFilter = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>;

        // --- Utility: Parse Date ---
        const parseDate = (dateStr) => {
            if (!dateStr) return 0;
            const parts = dateStr.split('/');
            if (parts.length !== 3) return 0;
            let day = parseInt(parts[0], 10);
            let month = parseInt(parts[1], 10) - 1; // Month is 0-indexed
            let year = parseInt(parts[2], 10);
            
            // Basic BE to AD conversion if year > 2400
            if (year > 2400) year -= 543;

            return new Date(year, month, day).getTime();
        };

        // --- New Isolated Map Component ---
        const MapComponent = ({ data }) => {
            const mapContainerRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markersLayerRef = useRef(null);

            useEffect(() => {
                if (!L || !mapContainerRef.current) return;

                const map = L.map(mapContainerRef.current, {
                    preferCanvas: true
                }).setView([13.7563, 100.5018], 11);
                
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; OpenStreetMap &copy; CARTO',
                    subdomains: 'abcd',
                    maxZoom: 19
                }).addTo(map);

                markersLayerRef.current = L.layerGroup().addTo(map);
                mapInstanceRef.current = map;

                if (data && data.length > 0) {
                    data.forEach(item => {
                        const isTree = item.type && item.type.includes('ยืนต้น');
                        const color = isTree ? '#15803d' : '#84cc16';
                        
                        const marker = L.circleMarker([item.lat, item.lng], {
                            radius: 5,
                            fillColor: color,
                            color: "#fff",
                            weight: 1,
                            opacity: 1,
                            fillOpacity: 0.8
                        });
                        
                        const popupHtml = `
                            <div style="font-family: 'Sarabun', sans-serif; min-width: 200px;">
                                <h3 style="margin:0 0 5px 0; color:#15803d; font-weight:bold;">${item.name || 'ไม่ระบุชื่อ'}</h3>
                                <div style="color:#666; font-size:0.9em; margin-bottom:5px;">${item.district} ${item.subdistrict ? '('+item.subdistrict+')' : ''}</div>
                                ${item.image && item.image.startsWith('http') 
                                    ? `<div style="width:100%; height:120px; background:#f0f0f0; border-radius:4px; overflow:hidden; margin-bottom:5px;">
                                         <img src="${item.image}" style="width:100%; height:100%; object-fit:cover;" onerror="this.style.display='none'" />
                                       </div>` 
                                    : ''}
                                <div style="font-size:0.85em; display:grid; grid-template-columns: auto 1fr; gap: 4px;">
                                    <strong>ประเภท:</strong> <span>${item.type}</span>
                                    <strong>จำนวน:</strong> <span>${item.quantity} ต้น</span>
                                    <strong>วันที่:</strong> <span>${item.date}</span>
                                </div>
                            </div>
                        `;
                        marker.bindPopup(popupHtml);
                        markersLayerRef.current.addLayer(marker);
                    });
                }

                setTimeout(() => {
                    map.invalidateSize();
                }, 250);

                return () => {
                    if (mapInstanceRef.current) {
                        mapInstanceRef.current.remove();
                        mapInstanceRef.current = null;
                        markersLayerRef.current = null;
                    }
                };
            }, [data]);

            return <div ref={mapContainerRef} className="w-full h-full bg-gray-100 rounded-lg"></div>;
        };

        const App = () => {
            const [data, setData] = useState(INITIAL_DATA);
            const [view, setView] = useState('dashboard'); // 'dashboard' | 'map' | 'latest'
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            // Filters for Latest View
            const [filterDistrict, setFilterDistrict] = useState('all');
            const [filterType, setFilterType] = useState('all');

            // --- Stats Logic ---
            const stats = useMemo(() => {
                try {
                    const totalTrees = data.reduce((acc, curr) => acc + (parseInt(curr.quantity) || 0), 0);
                    const districtCounts = {};
                    const typeCounts = {};
                    const districtList = new Set();
                    const typeList = new Set();

                    data.forEach(item => {
                        const dist = item.district ? item.district.trim() : 'ไม่ระบุ';
                        districtCounts[dist] = (districtCounts[dist] || 0) + (parseInt(item.quantity) || 0);
                        districtList.add(dist);
                        
                        const t = item.type ? item.type.trim() : 'อื่นๆ';
                        typeCounts[t] = (typeCounts[t] || 0) + (parseInt(item.quantity) || 0);
                        typeList.add(t);
                    });

                    const topDistrict = Object.entries(districtCounts).sort((a, b) => b[1] - a[1])[0] || ['-', 0];
                    const chartDataDistrict = Object.keys(districtCounts)
                        .map(k => ({ name: k, value: districtCounts[k] }))
                        .sort((a,b) => b.value - a.value)
                        .slice(0, 10);
                    
                    const chartDataType = Object.keys(typeCounts)
                        .map(k => ({ name: k, value: typeCounts[k] }))
                        .filter(item => item.value > 0);

                    return { 
                        totalTrees, 
                        topDistrict, 
                        chartDataDistrict, 
                        chartDataType, 
                        totalRecords: data.length,
                        districtList: Array.from(districtList).sort(),
                        typeList: Array.from(typeList).sort()
                    };
                } catch (err) {
                    console.error("Error calculating stats:", err);
                    return { totalTrees: 0, topDistrict: ['-',0], chartDataDistrict: [], chartDataType: [], totalRecords: 0, districtList:[], typeList:[] };
                }
            }, [data]);

            // --- Filtered Data for Latest View ---
            const filteredLatestData = useMemo(() => {
                let result = [...data];

                // 1. Filter
                if (filterDistrict !== 'all') {
                    result = result.filter(item => item.district === filterDistrict);
                }
                if (filterType !== 'all') {
                    result = result.filter(item => item.type === filterType);
                }

                // 2. Sort by Date Descending
                result.sort((a, b) => parseDate(b.date) - parseDate(a.date));

                return result.slice(0, 100); // Limit to top 100 for performance
            }, [data, filterDistrict, filterType]);


            // --- Fetch Public Sheet Handler ---
            const handleFetchPublicSheet = () => {
                setLoading(true);
                setError(null);

                Papa.parse(PUBLIC_SHEET_URL, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        try {
                            const parsedData = results.data.map((row, index) => ({
                                id: index,
                                district: row['เขต'],
                                subdistrict: row['แขวง'],
                                lat: parseFloat(row['latitude']),
                                lng: parseFloat(row['longitude']),
                                date: row['วันที่ปลูก'],
                                name: row['ชื่อต้นไม้ที่ปลูก'],
                                type: row['ประเภทต้นไม้ที่ปลูก'],
                                quantity: parseInt(row['จำนวนต้นไม้ (ต้น)']) || 0,
                                image: row['รูปของต้นไม้ที่ปลูก']
                            })).filter(item => 
                                !isNaN(item.lat) && 
                                !isNaN(item.lng) && 
                                item.lat !== 0 && 
                                item.lng !== 0
                            );

                            if (parsedData.length > 0) {
                                setData(parsedData);
                                setError(null);
                            } else {
                                setError("ไม่พบข้อมูลพิกัดในลิงก์ Google Sheet");
                            }
                        } catch (err) {
                            console.error(err);
                            setError("เกิดข้อผิดพลาดในการประมวลผลข้อมูลจาก Google Sheet");
                        }
                        setLoading(false);
                    },
                    error: (err) => {
                        console.error(err);
                        setError("ไม่สามารถดึงข้อมูลได้ (โปรดตรวจสอบอินเทอร์เน็ตหรือลิงก์ต้นทาง)");
                        setLoading(false);
                    }
                });
            };

            // --- File Handler ---
            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                setLoading(true);
                setError(null);

                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        try {
                            const parsedData = results.data.map((row, index) => ({
                                id: index,
                                district: row['เขต'],
                                subdistrict: row['แขวง'],
                                lat: parseFloat(row['latitude']),
                                lng: parseFloat(row['longitude']),
                                date: row['วันที่ปลูก'],
                                name: row['ชื่อต้นไม้ที่ปลูก'],
                                type: row['ประเภทต้นไม้ที่ปลูก'],
                                quantity: parseInt(row['จำนวนต้นไม้ (ต้น)']) || 0,
                                image: row['รูปของต้นไม้ที่ปลูก']
                            })).filter(item => 
                                !isNaN(item.lat) && 
                                !isNaN(item.lng) && 
                                item.lat !== 0 && 
                                item.lng !== 0
                            );

                            if (parsedData.length === 0) {
                                setError("ไม่พบข้อมูลพิกัดในไฟล์ หรือรูปแบบไฟล์ไม่ถูกต้อง");
                            } else {
                                setData(parsedData);
                            }
                        } catch (err) {
                            setError("เกิดข้อผิดพลาดในการประมวลผลไฟล์");
                            console.error(err);
                        }
                        setLoading(false);
                    },
                    error: (err) => {
                        setError("เกิดข้อผิดพลาดในการอ่านไฟล์ CSV");
                        setLoading(false);
                    }
                });
            };

            return (
                <div className="flex h-screen overflow-hidden bg-green-50 text-gray-800 font-sans">
                    
                    {/* Sidebar */}
                    <aside className="w-64 bg-white shadow-xl flex-shrink-0 flex flex-col z-20 hidden md:flex">
                        <div className="p-6 border-b border-green-100 flex items-center gap-3">
                            <div className="bg-green-600 text-white p-2 rounded-lg shadow-sm">
                                <IconTree />
                            </div>
                            <h1 className="font-bold text-lg text-green-900 leading-tight">Bangkok<br/>Green Monitor</h1>
                        </div>

                        <nav className="p-4 space-y-2 flex-1 overflow-y-auto">
                            <button 
                                onClick={() => setView('dashboard')}
                                className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all ${view === 'dashboard' ? 'bg-green-100 text-green-800 font-bold shadow-sm' : 'text-gray-600 hover:bg-gray-50'}`}
                            >
                                <IconBarChart /> ภาพรวมข้อมูล
                            </button>
                            <button 
                                onClick={() => setView('map')}
                                className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all ${view === 'map' ? 'bg-green-100 text-green-800 font-bold shadow-sm' : 'text-gray-600 hover:bg-gray-50'}`}
                            >
                                <IconMap /> แผนที่พิกัด
                            </button>
                            <button 
                                onClick={() => setView('latest')}
                                className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all ${view === 'latest' ? 'bg-green-100 text-green-800 font-bold shadow-sm' : 'text-gray-600 hover:bg-gray-50'}`}
                            >
                                <IconGallery /> ข้อมูลล่าสุด
                            </button>

                            <div className="mt-6 px-4">
                                <div className="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">แหล่งข้อมูล</div>
                                
                                {/* Public Sheet Button */}
                                <button 
                                    onClick={handleFetchPublicSheet}
                                    disabled={loading}
                                    className="w-full bg-blue-50 hover:bg-blue-100 text-blue-700 p-3 rounded-lg border border-blue-200 flex items-center gap-3 transition-colors mb-3 group"
                                >
                                    <div className="bg-blue-100 group-hover:bg-white p-1.5 rounded transition-colors">
                                        <IconCloudDownload size={18} />
                                    </div>
                                    <div className="text-left">
                                        <div className="text-xs font-bold">โหลดข้อมูลจาก Google Sheet</div>
                                        <div className="text-[10px] opacity-75">อัปเดตล่าสุดจากลิงก์สาธารณะ</div>
                                    </div>
                                </button>

                                <div className="text-center text-gray-400 text-xs my-2">- หรือ -</div>

                                {/* CSV Upload */}
                                <label className="flex flex-col items-center justify-center w-full h-16 border-2 border-green-300 border-dashed rounded-lg cursor-pointer hover:bg-green-50 transition-colors bg-white">
                                    <div className="flex flex-col items-center justify-center pt-2 pb-2">
                                        <IconUpload size={16} className="text-green-500"/>
                                        <p className="text-[10px] text-gray-500 font-medium mt-1">อัปโหลดไฟล์ CSV</p>
                                    </div>
                                    <input type="file" accept=".csv" className="hidden" onChange={handleFileUpload} />
                                </label>
                            </div>
                        </nav>
                    </aside>

                    {/* Mobile Header */}
                    <div className="md:hidden fixed top-0 left-0 right-0 h-16 bg-white shadow-md z-30 flex items-center justify-between px-4">
                        <div className="font-bold text-green-800 flex items-center gap-2">
                             <IconTree /> Green Monitor
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setView('dashboard')} className={`p-2 rounded ${view === 'dashboard' ? 'bg-green-100' : ''}`}><IconBarChart /></button>
                            <button onClick={() => setView('map')} className={`p-2 rounded ${view === 'map' ? 'bg-green-100' : ''}`}><IconMap /></button>
                            <button onClick={() => setView('latest')} className={`p-2 rounded ${view === 'latest' ? 'bg-green-100' : ''}`}><IconGallery /></button>
                        </div>
                    </div>

                    {/* Main Content */}
                    <main className="flex-1 flex flex-col overflow-hidden relative pt-16 md:pt-0">
                        {loading && (
                            <div className="absolute inset-0 bg-white/80 z-50 flex items-center justify-center backdrop-blur-sm">
                                <div className="flex flex-col items-center gap-3">
                                    <div className="w-10 h-10 border-4 border-green-200 border-t-green-600 rounded-full animate-spin"></div>
                                    <span className="text-green-800 font-semibold">กำลังดึงข้อมูล...</span>
                                </div>
                            </div>
                        )}

                        {error && (
                            <div className="m-4 p-4 bg-red-50 text-red-700 rounded-lg border border-red-200 flex items-center justify-between shadow-sm">
                                <span className="text-sm">{error}</span>
                                <button onClick={() => setError(null)} className="font-bold hover:text-red-900">✕</button>
                            </div>
                        )}

                        <div className="flex-1 overflow-y-auto p-4 md:p-8 space-y-6">
                            
                            {/* Stats Header */}
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div className="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500 transform hover:scale-105 transition-transform duration-200">
                                    <h3 className="text-gray-500 text-sm font-medium">ต้นไม้ทั้งหมด</h3>
                                    <p className="text-3xl font-bold text-gray-800 mt-1">{stats.totalTrees.toLocaleString()}</p>
                                </div>
                                <div className="bg-white p-6 rounded-xl shadow-sm border-l-4 border-lime-500 transform hover:scale-105 transition-transform duration-200">
                                    <h3 className="text-gray-500 text-sm font-medium">เขตที่ปลูกมากสุด</h3>
                                    <p className="text-3xl font-bold text-gray-800 mt-1">{stats.topDistrict[0]}</p>
                                    <p className="text-xs text-gray-400">จำนวน {stats.topDistrict[1].toLocaleString()} ต้น</p>
                                </div>
                                <div className="bg-white p-6 rounded-xl shadow-sm border-l-4 border-emerald-500 transform hover:scale-105 transition-transform duration-200">
                                    <h3 className="text-gray-500 text-sm font-medium">จุดพิกัดทั้งหมด</h3>
                                    <p className="text-3xl font-bold text-gray-800 mt-1">{stats.totalRecords.toLocaleString()}</p>
                                </div>
                            </div>

                            {/* View Content */}
                            {view === 'dashboard' && (
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 pb-8">
                                    {/* Bar Chart */}
                                    <div className="bg-white p-6 rounded-xl shadow-sm min-h-[400px]">
                                        <h3 className="text-lg font-bold text-gray-700 mb-4">10 อันดับเขตที่มีการปลูกต้นไม้</h3>
                                        <div className="h-[350px]">
                                            {window.Recharts ? (
                                                <ResponsiveContainer width="100%" height="100%">
                                                    <BarChart data={stats.chartDataDistrict} layout="vertical" margin={{left: 40}}>
                                                        <CartesianGrid strokeDasharray="3 3" horizontal={false} />
                                                        <XAxis type="number" />
                                                        <YAxis dataKey="name" type="category" width={100} tick={{fontSize: 12}} />
                                                        <Tooltip />
                                                        <Bar dataKey="value" fill="#22c55e" radius={[0, 4, 4, 0]} barSize={24} />
                                                    </BarChart>
                                                </ResponsiveContainer>
                                            ) : (
                                                <div className="h-full flex items-center justify-center text-gray-400">กำลังโหลดกราฟ...</div>
                                            )}
                                        </div>
                                    </div>

                                    {/* Pie Chart */}
                                    <div className="bg-white p-6 rounded-xl shadow-sm min-h-[400px]">
                                        <h3 className="text-lg font-bold text-gray-700 mb-4">สัดส่วนประเภทต้นไม้</h3>
                                        <div className="h-[350px]">
                                            {window.Recharts ? (
                                                <ResponsiveContainer width="100%" height="100%">
                                                    <PieChart>
                                                        <Pie
                                                            data={stats.chartDataType}
                                                            cx="50%"
                                                            cy="50%"
                                                            innerRadius={80}
                                                            outerRadius={120}
                                                            paddingAngle={5}
                                                            dataKey="value"
                                                        >
                                                            {stats.chartDataType.map((entry, index) => (
                                                                <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                                            ))}
                                                        </Pie>
                                                        <Tooltip />
                                                        <Legend verticalAlign="bottom" height={36}/>
                                                    </PieChart>
                                                </ResponsiveContainer>
                                            ) : (
                                                <div className="h-full flex items-center justify-center text-gray-400">กำลังโหลดกราฟ...</div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {view === 'map' && (
                                <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden h-[calc(100vh-250px)] min-h-[500px] relative">
                                    <MapComponent data={data} />
                                    
                                    <div className="absolute top-4 right-4 bg-white/95 backdrop-blur px-4 py-3 rounded-lg shadow-lg z-[1000] text-sm border border-gray-100">
                                        <div className="font-bold mb-2 text-gray-700">สัญลักษณ์</div>
                                        <div className="flex items-center gap-2 mb-1">
                                            <span className="w-3 h-3 rounded-full bg-green-700 border border-white shadow-sm"></span>
                                            <span>ไม้ยืนต้น</span>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <span className="w-3 h-3 rounded-full bg-lime-500 border border-white shadow-sm"></span>
                                            <span>ไม้พุ่ม/อื่นๆ</span>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {view === 'latest' && (
                                <div className="space-y-4">
                                    {/* Filter Bar */}
                                    <div className="bg-white p-4 rounded-xl shadow-sm border border-green-100 flex flex-col md:flex-row gap-4 items-center justify-between">
                                        <div className="flex items-center gap-2 text-green-800 font-bold">
                                            <IconGallery size={20}/>
                                            <span>ข้อมูลล่าสุด (100 รายการ)</span>
                                        </div>
                                        
                                        <div className="flex flex-col md:flex-row gap-3 w-full md:w-auto">
                                            <div className="flex items-center gap-2">
                                                <IconFilter size={16} className="text-gray-400"/>
                                                <span className="text-sm font-medium text-gray-600">กรองข้อมูล:</span>
                                            </div>
                                            <select 
                                                value={filterDistrict} 
                                                onChange={(e) => setFilterDistrict(e.target.value)}
                                                className="bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-green-500 focus:border-green-500 block p-2 outline-none"
                                            >
                                                <option value="all">ทุกเขต</option>
                                                {stats.districtList.map(d => <option key={d} value={d}>{d}</option>)}
                                            </select>
                                            <select 
                                                value={filterType} 
                                                onChange={(e) => setFilterType(e.target.value)}
                                                className="bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-green-500 focus:border-green-500 block p-2 outline-none"
                                            >
                                                <option value="all">ทุกประเภท</option>
                                                {stats.typeList.map(t => <option key={t} value={t}>{t}</option>)}
                                            </select>
                                        </div>
                                    </div>

                                    {/* Gallery Grid */}
                                    {filteredLatestData.length === 0 ? (
                                        <div className="text-center py-10 text-gray-400 bg-white rounded-xl border border-dashed border-gray-200">
                                            ไม่พบข้อมูลตามเงื่อนไขที่เลือก
                                        </div>
                                    ) : (
                                        <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                                            {filteredLatestData.map((item, index) => (
                                                <div key={`${item.id}-${index}`} className="bg-white rounded-lg shadow-sm border border-gray-100 overflow-hidden hover:shadow-md transition-shadow flex h-40">
                                                    {/* Image Section (Left - 40%) */}
                                                    <div className="w-2/5 relative bg-gray-100 flex-shrink-0">
                                                        {item.image && item.image.startsWith('http') ? (
                                                            <img 
                                                                src={item.image} 
                                                                alt={item.name} 
                                                                className="w-full h-full object-cover"
                                                                loading="lazy"
                                                                onError={(e) => {e.target.style.display='none'; e.target.parentElement.classList.add('flex','items-center','justify-center'); e.target.parentElement.innerHTML='<span class="text-xs text-gray-400">ไม่มีรูป</span>'}}
                                                            />
                                                        ) : (
                                                            <div className="w-full h-full flex items-center justify-center text-gray-300">
                                                                <IconTree size={32}/>
                                                            </div>
                                                        )}
                                                        
                                                        {/* Type Badge */}
                                                        <div className="absolute top-2 left-2 px-2 py-0.5 rounded text-[10px] font-bold text-white shadow-sm"
                                                            style={{backgroundColor: item.type && item.type.includes('ยืนต้น') ? '#15803d' : '#84cc16'}}>
                                                            {item.type}
                                                        </div>
                                                    </div>

                                                    {/* Info Section (Right) */}
                                                    <div className="w-3/5 p-4 flex flex-col justify-between">
                                                        <div>
                                                            <h4 className="font-bold text-green-800 line-clamp-1 mb-1" title={item.name}>{item.name || 'ไม่ระบุชื่อ'}</h4>
                                                            <div className="flex items-start gap-1 text-xs text-gray-500 mb-2">
                                                                <IconMap size={12} className="mt-0.5 flex-shrink-0"/>
                                                                <span className="line-clamp-2">เขต{item.district} {item.subdistrict && `(${item.subdistrict})`}</span>
                                                            </div>
                                                        </div>
                                                        
                                                        <div className="border-t border-gray-100 pt-2 flex justify-between items-end text-xs">
                                                            <div>
                                                                <span className="text-gray-400 block text-[10px]">จำนวน</span>
                                                                <span className="font-bold text-gray-700 text-sm">{item.quantity}</span> <span className="text-gray-500">ต้น</span>
                                                            </div>
                                                            <div className="text-right">
                                                                <span className="text-gray-400 block text-[10px]">วันที่ปลูก</span>
                                                                <span className="text-green-600 font-medium">{item.date}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            )}

                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>    
