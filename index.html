<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bangkok Green Monitor - ระบบติดตามพื้นที่สีเขียว</title>
    
    <!-- 1. Load Utilities -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <!-- 2. React Core -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 3. Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 4. UI Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/recharts@2.12.0/umd/Recharts.js"></script>
    
    <!-- 5. Map Library -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f0fdf4;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        #root {
            height: 100vh;
            width: 100vw;
        }

        /* Loading Spinner */
        #initial-loader {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
            background-color: #f0fdf4;
            color: #166534;
            font-size: 1.5rem;
            font-weight: bold;
            flex-direction: column;
            gap: 1rem;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #bbf7d0;
            border-top: 4px solid #16a34a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .leaflet-container {
            width: 100%;
            height: 100%;
            z-index: 1;
            background: #e5e7eb;
        }

        /* --- Dynamic Pulsing Marker CSS --- */
        .pulsing-icon {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .pulsing-ring {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            opacity: 0.6;
            animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
        .tree-marker-icon {
            position: absolute;
            width: 28px;
            height: 28px;
            background-color: #ffffff;
            border-width: 2px;
            border-style: solid;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            z-index: 10;
        }
        
        @keyframes pulse-ring {
            0% { transform: scale(0.5); opacity: 0.8; }
            100% { transform: scale(2.5); opacity: 0; }
        }
    </style>
</head>
<body>
    <div id="root">
        <div id="initial-loader">
            <div class="spinner"></div>
            <div>กำลังโหลดข้อมูล...</div>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell } = window.Recharts || {};
        const L = window.L;

        const PUBLIC_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQXj3ANlfrhd00qkUJlPPSqR6GrIZethvWJem7gyLBGyihVjIqE4Lx2hTufmLuNgmK8NR89vQly0WeU/pub?gid=0&single=true&output=csv";
        const BANGKOK_BOUNDS = [[13.49, 100.32], [13.96, 100.93]];
        const COLORS = ['#16a34a', '#84cc16', '#10b981', '#15803d', '#4ade80', '#14532d', '#059669', '#34d399'];

        // --- Icons ---
        const IconTree = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 10v.2A3 3 0 0 1 8.9 16v0H5v0h0a3 3 0 0 1-1-5.8V10a3 3 0 0 1 5.3-2.1"/><path d="M7 16v6"/><path d="M13 19v3"/><path d="M12 19h8.3a1 1 0 0 0 .7-1.7L18 14h.3a1 1 0 0 0 .7-1.7L16 9h.2a1 1 0 0 0 .9-1.7l-2-6a1 1 0 0 0-1.9 0l-2 6a1 1 0 0 0 .9 1.7h.2l-2 3.3a1 1 0 0 0 .7 1.7H13z"/></svg>;
        const IconMap = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" x2="9" y1="3" y2="18"/><line x1="15" x2="15" y1="6" y2="21"/></svg>;
        const IconBarChart = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></svg>;
        const IconUpload = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>;
        const IconFilter = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>;
        const IconSearchMap = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>;
        const IconCalendar = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>;
        const IconLeaf = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10Z"/><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"/></svg>;

        // --- Utilities ---
        const parseDateTimestamp = (dateStr) => {
            if (!dateStr) return 0;
            const parts = dateStr.split('/');
            if (parts.length !== 3) return 0;
            let year = parseInt(parts[2], 10);
            if (year > 2400) year -= 543;
            return new Date(year, parseInt(parts[1], 10) - 1, parseInt(parts[0], 10)).getTime();
        };

        const parseMonthYear = (dateStr) => {
            if (!dateStr) return null;
            const parts = dateStr.split('/');
            if (parts.length !== 3) return null;
            let year = parseInt(parts[2], 10);
            const month = parts[1].padStart(2, '0');
            if (year > 2400) year -= 543; 
            return `${year}-${month}`;
        };

        const formatMonthYearTH = (yyyy_mm) => {
            if (!yyyy_mm) return "ไม่ระบุ";
            const [year, month] = yyyy_mm.split('-');
            if (!month) return yyyy_mm;
            const thaiMonths = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];
            const monthName = thaiMonths[parseInt(month, 10) - 1];
            const thaiYear = parseInt(year, 10) + 543;
            return `${monthName} ${thaiYear}`;
        };

        const getTreeStyle = (typeStr) => {
            if (!typeStr) return { color: '#10b981' }; // Emerald Green
            if (typeStr.includes('ยืนต้น')) return { color: '#15803d' }; // Dark Green
            if (typeStr.includes('พุ่ม')) return { color: '#84cc16' }; // Lime Green
            return { color: '#10b981' }; // Emerald Green for Others/Climbers
        };

        const getRichPopupHTML = (item, typeColor) => {
            return `
                <div style="font-family: 'Sarabun', sans-serif; min-width: 220px;">
                    <h3 style="margin:0 0 5px 0; color:${typeColor}; font-weight:bold; font-size: 16px; line-height: 1.2;">
                        ${item.name || 'ไม่ระบุชื่อ'}
                    </h3>
                    ${item.image && item.image.startsWith('http') 
                        ? `<div style="width:100%; height:120px; background:#f0f0f0; border-radius:6px; overflow:hidden; margin-bottom:8px;">
                                <img src="${item.image}" style="width:100%; height:100%; object-fit:cover;" onerror="this.style.display='none'" />
                            </div>` 
                        : ''}
                    <div style="font-size:13px; margin-bottom: 10px; line-height: 1.4; color: #4b5563;">
                        <div style="display:flex; justify-content:space-between; border-bottom: 1px solid #f3f4f6; padding-bottom: 2px; margin-bottom: 2px;">
                            <span><strong>เขต:</strong></span> <span>${item.district} ${item.subdistrict ? `(${item.subdistrict})` : ''}</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; border-bottom: 1px solid #f3f4f6; padding-bottom: 2px; margin-bottom: 2px;">
                            <span><strong>ประเภท:</strong></span> <span style="color:${typeColor}; font-weight:bold;">${item.type}</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; border-bottom: 1px solid #f3f4f6; padding-bottom: 2px; margin-bottom: 2px;">
                            <span><strong>จำนวน:</strong></span> <span>${item.quantity} ต้น</span>
                        </div>
                        <div style="display:flex; justify-content:space-between;">
                            <span><strong>วันที่:</strong></span> <span>${item.date}</span>
                        </div>
                    </div>
                    <a href="https://www.google.com/maps?q=${item.lat},${item.lng}" target="_blank" 
                        style="display:flex; align-items:center; justify-content:center; gap:5px; background-color:#2563eb; color:white; padding:8px 10px; border-radius:6px; text-decoration:none; font-size:12px; font-weight:bold; transition: background-color 0.2s;"
                        onmouseover="this.style.backgroundColor='#1d4ed8'" onmouseout="this.style.backgroundColor='#2563eb'">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg>
                        ดู Google Street View
                    </a>
                </div>
            `;
        };

        // --- Summary List Component ---
        const SummaryList = ({ title, data, icon, formatName }) => (
            <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col h-72">
                <h3 className="text-[15px] font-bold text-gray-700 mb-3 flex items-center gap-2 border-b border-gray-100 pb-2">
                    <span className="text-green-600 bg-green-50 p-1.5 rounded-lg">{icon}</span> {title}
                </h3>
                <div className="flex-1 overflow-y-auto pr-2 space-y-1.5">
                    {data.length === 0 ? <div className="text-center text-xs text-gray-400 py-4">ไม่มีข้อมูล</div> :
                     data.map((item, idx) => (
                        <div key={idx} className="flex justify-between items-center text-sm p-2 hover:bg-green-50 rounded transition-colors">
                            <span className="text-gray-600 truncate mr-2" title={item.name}>
                                {formatName ? formatName(item.name) : item.name}
                            </span>
                            <span className="font-bold text-green-700 bg-green-100 px-2 py-0.5 rounded text-xs">
                                {item.value.toLocaleString()}
                            </span>
                        </div>
                    ))}
                </div>
            </div>
        );


        const MapComponent = ({ data, focusLocation }) => {
            const mapContainerRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markersLayerRef = useRef(null);
            const highlightLayerRef = useRef(null);

            useEffect(() => {
                if (!L || !mapContainerRef.current || mapInstanceRef.current) return;

                const map = L.map(mapContainerRef.current, {
                    preferCanvas: true,
                    zoomControl: false
                });
                
                map.fitBounds(BANGKOK_BOUNDS);
                L.control.zoom({ position: 'bottomright' }).addTo(map);
                
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; OpenStreetMap &copy; CARTO',
                    subdomains: 'abcd',
                    maxZoom: 19
                }).addTo(map);

                markersLayerRef.current = L.layerGroup().addTo(map);
                highlightLayerRef.current = L.layerGroup().addTo(map);
                mapInstanceRef.current = map;

                return () => {
                    if (mapInstanceRef.current) {
                        mapInstanceRef.current.remove();
                        mapInstanceRef.current = null;
                        markersLayerRef.current = null;
                        highlightLayerRef.current = null;
                    }
                };
            }, []);

            useEffect(() => {
                if (mapInstanceRef.current) setTimeout(() => mapInstanceRef.current.invalidateSize(), 300);
            }, [data]);

            // Handle Focus: Zoom + Dynamic Colored Flash + Rich Popup
            useEffect(() => {
                if (mapInstanceRef.current && focusLocation && highlightLayerRef.current) {
                    const { lat, lng, item } = focusLocation;
                    highlightLayerRef.current.clearLayers();
                    mapInstanceRef.current.flyTo([lat, lng], 18, { animate: true, duration: 1.2 });

                    const style = getTreeStyle(item.type);
                    const typeColor = style.color;
                    
                    const iconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 10v.2A3 3 0 0 1 8.9 16v0H5v0h0a3 3 0 0 1-1-5.8V10a3 3 0 0 1 5.3-2.1"/><path d="M7 16v6"/><path d="M13 19v3"/><path d="M12 19h8.3a1 1 0 0 0 .7-1.7L18 14h.3a1 1 0 0 0 .7-1.7L16 9h.2a1 1 0 0 0 .9-1.7l-2-6a1 1 0 0 0-1.9 0l-2 6a1 1 0 0 0 .9 1.7h.2l-2 3.3a1 1 0 0 0 .7 1.7H13z"/></svg>`;

                    const pulsingIcon = L.divIcon({
                        className: 'pulsing-icon',
                        html: `
                            <div class="pulsing-ring" style="background-color: ${typeColor};"></div>
                            <div class="tree-marker-icon" style="border-color: ${typeColor}; color: ${typeColor};">
                                ${iconSVG}
                            </div>
                        `,
                        iconSize: [40, 40],
                        iconAnchor: [20, 20]
                    });

                    const highlightMarker = L.marker([lat, lng], { icon: pulsingIcon });
                    highlightMarker.bindPopup(getRichPopupHTML(item, typeColor));
                    highlightLayerRef.current.addLayer(highlightMarker);

                    setTimeout(() => { highlightMarker.openPopup(); }, 1200);
                }
            }, [focusLocation]);

            // Handle Normal Markers
            useEffect(() => {
                if (!mapInstanceRef.current || !markersLayerRef.current) return;
                markersLayerRef.current.clearLayers();
                
                data.forEach(item => {
                    const style = getTreeStyle(item.type);
                    const marker = L.circleMarker([item.lat, item.lng], {
                        radius: 5, fillColor: style.color, color: "#fff", weight: 1, opacity: 1, fillOpacity: 0.8
                    });
                    
                    marker.bindPopup(getRichPopupHTML(item, style.color));
                    markersLayerRef.current.addLayer(marker);
                });
            }, [data]); 

            return (
                <div className="relative w-full h-full">
                    <div ref={mapContainerRef} className="w-full h-full z-0"></div>
                    <div className="absolute bottom-8 left-4 z-[500] bg-white/90 backdrop-blur px-3 py-2 rounded-lg shadow border border-gray-200 text-xs">
                        <div className="font-bold text-gray-700 mb-1 border-b border-gray-100 pb-1">ประเภทต้นไม้</div>
                        <div className="flex items-center gap-2 mb-1">
                            <span className="w-3 h-3 rounded-full border border-white shadow-sm" style={{backgroundColor: '#15803d'}}></span>
                            <span>ไม้ยืนต้น</span>
                        </div>
                        <div className="flex items-center gap-2 mb-1">
                            <span className="w-3 h-3 rounded-full border border-white shadow-sm" style={{backgroundColor: '#84cc16'}}></span>
                            <span>ไม้พุ่ม</span>
                        </div>
                        <div className="flex items-center gap-2">
                            <span className="w-3 h-3 rounded-full border border-white shadow-sm" style={{backgroundColor: '#10b981'}}></span>
                            <span>ไม้อื่นๆ / ไม้เลื้อย</span>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [data, setData] = useState([]); 
            const [view, setView] = useState('map');
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            
            const [filterDistrict, setFilterDistrict] = useState('all');
            const [filterType, setFilterType] = useState('all');
            const [filterMonth, setFilterMonth] = useState('all');
            const [filterSpecies, setFilterSpecies] = useState('all');
            
            const [mapFocusLocation, setMapFocusLocation] = useState(null);

            const fetchSheetData = useCallback(() => {
                setLoading(true);
                setError(null);
                Papa.parse(PUBLIC_SHEET_URL, {
                    download: true, header: true, skipEmptyLines: true,
                    complete: (results) => {
                         const parsedData = results.data.map((row, index) => ({
                            id: index, district: row['เขต'], subdistrict: row['แขวง'],
                            lat: parseFloat(row['latitude']), lng: parseFloat(row['longitude']),
                            date: row['วันที่ปลูก'], name: row['ชื่อต้นไม้ที่ปลูก'],
                            type: row['ประเภทต้นไม้ที่ปลูก'], quantity: parseInt(row['จำนวนต้นไม้ (ต้น)']) || 0,
                            image: row['รูปของต้นไม้ที่ปลูก']
                        })).filter(item => !isNaN(item.lat) && !isNaN(item.lng) && item.lat !== 0 && item.lng !== 0);
                        
                        if (parsedData.length > 0) { setData(parsedData); } 
                        else { setError("ไม่พบข้อมูลพิกัดในลิงก์ Google Sheet"); }
                        setLoading(false);
                    },
                    error: (err) => { setError("ไม่สามารถดึงข้อมูลได้ โปรดตรวจสอบการเชื่อมต่ออินเทอร์เน็ต"); setLoading(false); }
                });
            }, []);

            useEffect(() => { fetchSheetData(); }, [fetchSheetData]);

            // --- Stats & Detailed Summaries ---
            const stats = useMemo(() => {
                const totalTrees = data.reduce((acc, curr) => acc + (parseInt(curr.quantity) || 0), 0);
                
                const districtCounts = {};
                const typeCounts = {};
                const monthCounts = {};
                const speciesCounts = {};
                
                const districtSet = new Set();
                const typeSet = new Set();
                const monthSet = new Set();
                const speciesSet = new Set();

                data.forEach(item => {
                    const qty = parseInt(item.quantity) || 0;
                    
                    // District
                    const dist = item.district ? item.district.trim() : 'ไม่ระบุ';
                    districtCounts[dist] = (districtCounts[dist] || 0) + qty;
                    districtSet.add(dist);
                    
                    // Type
                    const t = item.type ? item.type.trim() : 'อื่นๆ';
                    typeCounts[t] = (typeCounts[t] || 0) + qty;
                    typeSet.add(t);

                    // Month
                    const my = parseMonthYear(item.date);
                    if (my) {
                        monthCounts[my] = (monthCounts[my] || 0) + qty;
                        monthSet.add(my);
                    }

                    // Species
                    const sp = item.name ? item.name.trim() : 'ไม่ระบุชื่อ';
                    speciesCounts[sp] = (speciesCounts[sp] || 0) + qty;
                    speciesSet.add(sp);
                });

                const topDistrict = Object.entries(districtCounts).sort((a, b) => b[1] - a[1])[0] || ['-', 0];
                
                // Chart Data formats
                const chartDataDistrict = Object.keys(districtCounts).map(k => ({ name: k, value: districtCounts[k] })).sort((a,b) => b.value - a.value).slice(0, 10);
                const chartDataType = Object.keys(typeCounts).map(k => ({ name: k, value: typeCounts[k] })).filter(item => item.value > 0);

                // Table Data Formats (Full Lists)
                const tableDistrict = Object.keys(districtCounts).map(k => ({ name: k, value: districtCounts[k] })).sort((a,b) => b.value - a.value);
                const tableType = Object.keys(typeCounts).map(k => ({ name: k, value: typeCounts[k] })).sort((a,b) => b.value - a.value);
                const tableSpecies = Object.keys(speciesCounts).map(k => ({ name: k, value: speciesCounts[k] })).sort((a,b) => b.value - a.value);
                // Sort months by newest first
                const tableMonth = Object.keys(monthCounts).map(k => ({ name: k, value: monthCounts[k] })).sort((a,b) => b.name.localeCompare(a.name));

                return { 
                    totalTrees, topDistrict, chartDataDistrict, chartDataType, totalRecords: data.length,
                    districtList: Array.from(districtSet).sort(),
                    typeList: Array.from(typeSet).sort(),
                    monthList: Array.from(monthSet).sort().reverse(),
                    speciesList: Array.from(speciesSet).sort(),
                    // Detailed tables
                    tableDistrict, tableType, tableSpecies, tableMonth
                };
            }, [data]);

            const filteredData = useMemo(() => {
                let result = [...data];
                if (filterDistrict !== 'all') result = result.filter(item => item.district === filterDistrict);
                if (filterType !== 'all') result = result.filter(item => item.type === filterType);
                if (filterMonth !== 'all') result = result.filter(item => parseMonthYear(item.date) === filterMonth);
                if (filterSpecies !== 'all') result = result.filter(item => (item.name ? item.name.trim() : 'ไม่ระบุชื่อ') === filterSpecies);
                
                result.sort((a, b) => parseDateTimestamp(b.date) - parseDateTimestamp(a.date));
                return result;
            }, [data, filterDistrict, filterType, filterMonth, filterSpecies]);

            const galleryItems = filteredData.slice(0, 100);

            const handleZoomToMap = (item) => {
                setMapFocusLocation({ lat: item.lat, lng: item.lng, item: item });
            };

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                setLoading(true);
                Papa.parse(file, {
                    header: true, skipEmptyLines: true,
                    complete: (results) => {
                        const parsedData = results.data.map((row, index) => ({
                            id: index, district: row['เขต'], subdistrict: row['แขวง'],
                            lat: parseFloat(row['latitude']), lng: parseFloat(row['longitude']),
                            date: row['วันที่ปลูก'], name: row['ชื่อต้นไม้ที่ปลูก'],
                            type: row['ประเภทต้นไม้ที่ปลูก'], quantity: parseInt(row['จำนวนต้นไม้ (ต้น)']) || 0,
                            image: row['รูปของต้นไม้ที่ปลูก']
                        })).filter(item => !isNaN(item.lat) && !isNaN(item.lng));
                        setData(parsedData); setLoading(false);
                    }
                });
            };

            return (
                <div className="flex h-screen overflow-hidden bg-white text-gray-800 font-sans">
                    
                    <aside className="w-16 md:w-64 bg-white shadow-xl flex-shrink-0 flex flex-col z-30 border-r border-gray-100 hidden md:flex">
                        <div className="p-4 border-b border-green-100 flex items-center gap-3">
                            <div className="bg-green-600 text-white p-2 rounded-lg shadow-sm flex-shrink-0">
                                <IconTree size={24}/>
                            </div>
                            <h1 className="font-bold text-lg text-green-900 leading-tight hidden md:block">Bangkok<br/>Green Monitor</h1>
                        </div>
                        <nav className="p-2 space-y-2 flex-1 overflow-y-auto">
                            <button onClick={() => setView('dashboard')} className={`w-full flex items-center gap-3 px-3 py-3 rounded-lg transition-all ${view === 'dashboard' ? 'bg-green-50 text-green-800 font-bold' : 'text-gray-600 hover:bg-gray-50'}`}>
                                <IconBarChart size={20} className="flex-shrink-0"/> <span className="hidden md:block">ภาพรวมข้อมูล</span>
                            </button>
                            <button onClick={() => setView('map')} className={`w-full flex items-center gap-3 px-3 py-3 rounded-lg transition-all ${view === 'map' ? 'bg-green-50 text-green-800 font-bold' : 'text-gray-600 hover:bg-gray-50'}`}>
                                <IconMap size={20} className="flex-shrink-0"/> <span className="hidden md:block">แผนที่และข้อมูล</span>
                            </button>
                            <div className="mt-6 px-2 hidden md:block">
                                <div className="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2 border-t border-gray-100 pt-4">โหลดข้อมูลแบบ Manual</div>
                                <button onClick={fetchSheetData} disabled={loading} className="w-full bg-blue-50 hover:bg-blue-100 text-blue-700 p-2 rounded-lg border border-blue-200 flex items-center gap-2 transition-colors mb-2 group">
                                    <div className="bg-blue-100 group-hover:bg-white p-1 rounded transition-colors"><IconMap size={14} /></div>
                                    <div className="text-left text-[11px] font-bold">รีเฟรชข้อมูล (Sheet)</div>
                                </button>
                                <label className="flex flex-col items-center justify-center w-full py-2 border border-gray-200 border-dashed rounded-lg cursor-pointer hover:bg-gray-50 transition-colors bg-white">
                                    <div className="flex items-center gap-1 text-gray-500"><IconUpload size={12}/> <span className="text-[10px] font-medium">อัปโหลด CSV เอง</span></div>
                                    <input type="file" accept=".csv" className="hidden" onChange={handleFileUpload} />
                                </label>
                            </div>
                        </nav>
                    </aside>

                    <div className="md:hidden fixed top-0 left-0 right-0 h-16 bg-white shadow-md z-30 flex items-center justify-between px-4">
                        <div className="font-bold text-green-800 flex items-center gap-2"><IconTree /> Green Monitor</div>
                        <div className="flex gap-2">
                            <button onClick={() => setView('dashboard')} className={`p-2 rounded ${view === 'dashboard' ? 'bg-green-100' : ''}`}><IconBarChart /></button>
                            <button onClick={() => setView('map')} className={`p-2 rounded ${view === 'map' ? 'bg-green-100' : ''}`}><IconMap /></button>
                        </div>
                    </div>

                    <main className="flex-1 flex flex-col relative h-full pt-16 md:pt-0 overflow-hidden">
                        {loading && (
                            <div className="absolute inset-0 bg-white/80 z-[2000] flex items-center justify-center backdrop-blur-sm">
                                <div className="flex flex-col items-center gap-3">
                                    <div className="w-10 h-10 border-4 border-green-200 border-t-green-600 rounded-full animate-spin"></div>
                                    <span className="text-green-800 font-semibold">กำลังดึงข้อมูลล่าสุดจากระบบ...</span>
                                </div>
                            </div>
                        )}
                         {error && (
                            <div className="absolute top-4 left-4 right-4 z-[2000] p-4 bg-red-50 text-red-700 rounded-lg border border-red-200 flex items-center justify-between shadow-lg">
                                <span className="text-sm">{error}</span>
                                <button onClick={() => setError(null)} className="font-bold hover:text-red-900">✕</button>
                            </div>
                        )}

                        {view === 'dashboard' ? (
                            <div className="flex-1 overflow-y-auto p-4 md:p-8 bg-green-50">
                                
                                {/* Top Stats */}
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                    <div className="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500"><h3 className="text-gray-500 text-sm font-medium">ต้นไม้ทั้งหมดที่ปลูกแล้ว</h3><p className="text-3xl font-bold text-gray-800 mt-1">{stats.totalTrees.toLocaleString()} <span className="text-base font-normal text-gray-400">ต้น</span></p></div>
                                    <div className="bg-white p-6 rounded-xl shadow-sm border-l-4 border-lime-500"><h3 className="text-gray-500 text-sm font-medium">เขตที่ปลูกมากสุด</h3><p className="text-3xl font-bold text-gray-800 mt-1">{stats.topDistrict[0]}</p><p className="text-xs text-gray-400">จำนวน {stats.topDistrict[1].toLocaleString()} ต้น</p></div>
                                    <div className="bg-white p-6 rounded-xl shadow-sm border-l-4 border-emerald-500"><h3 className="text-gray-500 text-sm font-medium">จำนวนจุดพิกัดที่บันทึก</h3><p className="text-3xl font-bold text-gray-800 mt-1">{stats.totalRecords.toLocaleString()} <span className="text-base font-normal text-gray-400">จุด</span></p></div>
                                </div>

                                {/* Charts */}
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                                    <div className="bg-white p-6 rounded-xl shadow-sm min-h-[400px]">
                                        <h3 className="text-lg font-bold text-gray-700 mb-4 flex items-center gap-2"><IconBarChart size={20} className="text-green-600"/> 10 อันดับเขตที่มีการปลูกต้นไม้</h3>
                                        <div className="h-[320px]">
                                            {window.Recharts ? (
                                                <ResponsiveContainer width="100%" height="100%">
                                                    <BarChart data={stats.chartDataDistrict} layout="vertical" margin={{left: 40}}>
                                                        <CartesianGrid strokeDasharray="3 3" horizontal={false} />
                                                        <XAxis type="number" />
                                                        <YAxis dataKey="name" type="category" width={100} tick={{fontSize: 12}} />
                                                        <Tooltip />
                                                        <Bar dataKey="value" fill="#22c55e" radius={[0, 4, 4, 0]} barSize={24} />
                                                    </BarChart>
                                                </ResponsiveContainer>
                                            ) : <div className="h-full flex items-center justify-center text-gray-400">กำลังโหลดกราฟ...</div>}
                                        </div>
                                    </div>
                                    <div className="bg-white p-6 rounded-xl shadow-sm min-h-[400px]">
                                        <h3 className="text-lg font-bold text-gray-700 mb-4 flex items-center gap-2"><IconTree size={20} className="text-green-600"/> สัดส่วนประเภทต้นไม้</h3>
                                        <div className="h-[320px]">
                                            {window.Recharts ? (
                                                <ResponsiveContainer width="100%" height="100%">
                                                    <PieChart>
                                                        <Pie data={stats.chartDataType} cx="50%" cy="50%" innerRadius={80} outerRadius={120} paddingAngle={5} dataKey="value">
                                                            {stats.chartDataType.map((entry, index) => (<Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />))}
                                                        </Pie>
                                                        <Tooltip />
                                                        <Legend verticalAlign="bottom" height={36}/>
                                                    </PieChart>
                                                </ResponsiveContainer>
                                            ) : <div className="h-full flex items-center justify-center text-gray-400">กำลังโหลดกราฟ...</div>}
                                        </div>
                                    </div>
                                </div>

                                {/* Detailed Summary Tables */}
                                <h2 className="text-xl font-bold text-gray-800 mb-4">ตารางสรุปข้อมูลแบบละเอียด</h2>
                                <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 pb-8">
                                    <SummaryList 
                                        title="ยอดปลูกรายเขต" 
                                        data={stats.tableDistrict} 
                                        icon={<IconMap size={16}/>} 
                                    />
                                    <SummaryList 
                                        title="ยอดปลูกแต่ละประเภท" 
                                        data={stats.tableType} 
                                        icon={<IconTree size={16}/>} 
                                    />
                                    <SummaryList 
                                        title="ชนิดต้นไม้ยอดนิยม" 
                                        data={stats.tableSpecies} 
                                        icon={<IconLeaf size={16}/>} 
                                    />
                                    <SummaryList 
                                        title="ยอดปลูกแต่ละช่วงเดือน" 
                                        data={stats.tableMonth} 
                                        icon={<IconCalendar size={16}/>} 
                                        formatName={formatMonthYearTH}
                                    />
                                </div>

                            </div>
                        ) : (
                            <div className="flex w-full h-full overflow-hidden">
                                <div className="flex-1 relative h-full bg-gray-200">
                                    <MapComponent 
                                        data={filteredData}
                                        focusLocation={mapFocusLocation}
                                    />
                                </div>
                                <div className="w-80 md:w-96 bg-white border-l border-gray-200 flex flex-col h-full shadow-2xl z-20">
                                    <div className="p-4 border-b border-gray-100 bg-gray-50">
                                        <div className="flex items-center justify-between mb-3">
                                            <div className="flex items-center gap-2 text-green-800 font-bold">
                                                <IconFilter size={18}/> <span>ตัวกรองข้อมูล</span>
                                            </div>
                                            <button 
                                                onClick={() => {
                                                    setFilterDistrict('all'); setFilterType('all'); setFilterMonth('all'); setFilterSpecies('all');
                                                }}
                                                className="text-xs text-gray-400 hover:text-green-600 underline"
                                            >
                                                ล้างตัวกรอง
                                            </button>
                                        </div>
                                        
                                        <div className="grid grid-cols-2 gap-x-2 gap-y-3">
                                            <div>
                                                <label className="text-[10px] text-gray-500 uppercase font-bold tracking-wider">เขต</label>
                                                <select value={filterDistrict} onChange={(e) => setFilterDistrict(e.target.value)} className="w-full mt-1 text-sm border-gray-300 rounded-md shadow-sm focus:border-green-500 focus:ring-green-500 bg-white border p-1.5">
                                                    <option value="all">ทุกเขต</option>
                                                    {stats.districtList.map(d => <option key={d} value={d}>{d}</option>)}
                                                </select>
                                            </div>
                                            <div>
                                                <label className="text-[10px] text-gray-500 uppercase font-bold tracking-wider">ช่วงเดือน</label>
                                                <select value={filterMonth} onChange={(e) => setFilterMonth(e.target.value)} className="w-full mt-1 text-sm border-gray-300 rounded-md shadow-sm focus:border-green-500 focus:ring-green-500 bg-white border p-1.5">
                                                    <option value="all">ทุกเดือน</option>
                                                    {stats.monthList.map(m => <option key={m} value={m}>{formatMonthYearTH(m)}</option>)}
                                                </select>
                                            </div>
                                            <div>
                                                <label className="text-[10px] text-gray-500 uppercase font-bold tracking-wider">ประเภท</label>
                                                <select value={filterType} onChange={(e) => setFilterType(e.target.value)} className="w-full mt-1 text-sm border-gray-300 rounded-md shadow-sm focus:border-green-500 focus:ring-green-500 bg-white border p-1.5">
                                                    <option value="all">ทุกประเภท</option>
                                                    {stats.typeList.map(t => <option key={t} value={t}>{t}</option>)}
                                                </select>
                                            </div>
                                            <div>
                                                <label className="text-[10px] text-gray-500 uppercase font-bold tracking-wider">ชนิดต้นไม้</label>
                                                <select value={filterSpecies} onChange={(e) => setFilterSpecies(e.target.value)} className="w-full mt-1 text-sm border-gray-300 rounded-md shadow-sm focus:border-green-500 focus:ring-green-500 bg-white border p-1.5">
                                                    <option value="all">ทุกชนิด</option>
                                                    {stats.speciesList.map(s => <option key={s} value={s}>{s}</option>)}
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="px-4 py-2 bg-green-600 text-white text-xs font-semibold flex justify-between items-center shadow-sm">
                                        <span>ผลลัพธ์: {filteredData.length.toLocaleString()} รายการ</span>
                                        <span>(แสดงล่าสุด 100)</span>
                                    </div>

                                    <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50">
                                        {galleryItems.length === 0 ? (
                                            <div className="text-center py-10 text-gray-400 flex flex-col items-center gap-2">
                                                <IconTree size={40} className="text-gray-300"/>
                                                <span>ไม่พบข้อมูลตามเงื่อนไขที่เลือก</span>
                                            </div>
                                        ) : (
                                            galleryItems.map((item, index) => {
                                                const badgeStyle = getTreeStyle(item.type);
                                                return (
                                                    <div 
                                                        key={`${item.id}-${index}`} 
                                                        className="bg-white rounded-lg shadow-sm border border-gray-100 overflow-hidden hover:shadow-md hover:border-green-300 transition-all cursor-pointer group flex flex-col"
                                                        onClick={() => handleZoomToMap(item)}
                                                    >
                                                        <div className="relative h-32 bg-gray-100 overflow-hidden">
                                                            {item.image && item.image.startsWith('http') ? (
                                                                <img src={item.image} alt={item.name} className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" loading="lazy"/>
                                                            ) : (
                                                                <div className="w-full h-full flex items-center justify-center text-gray-300"><IconTree size={32}/></div>
                                                            )}
                                                            <div className="absolute top-2 left-2 px-2 py-0.5 rounded text-[10px] font-bold text-white shadow-sm" style={{backgroundColor: badgeStyle.color}}>
                                                                {item.type}
                                                            </div>
                                                            <div className="absolute bottom-2 right-2 bg-white/90 p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity shadow-sm">
                                                                <IconSearchMap size={14} className="text-green-700"/>
                                                            </div>
                                                        </div>
                                                        <div className="p-3">
                                                            <h4 className="font-bold text-gray-800 text-sm line-clamp-1 mb-1">{item.name || 'ไม่ระบุชื่อ'}</h4>
                                                            <div className="flex items-center gap-1 text-xs text-gray-500 mb-2">
                                                                <IconMap size={10} className="flex-shrink-0"/>
                                                                <span className="line-clamp-1">เขต{item.district} {item.subdistrict && `(${item.subdistrict})`}</span>
                                                            </div>
                                                            <div className="flex justify-between items-end border-t border-gray-50 pt-2 mt-1">
                                                                <div className="flex flex-col">
                                                                    <span className="text-[10px] text-gray-400">จำนวน</span>
                                                                    <span className="font-bold text-green-700 text-sm leading-none">{item.quantity}</span>
                                                                </div>
                                                                <div className="text-[10px] text-gray-400 bg-gray-100 px-2 py-1 rounded">
                                                                    {item.date}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
